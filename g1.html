<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta charset="UTF-8"> 
<style>
    body {
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif
    }
canvas {
    border: 1px solid #d3d3d3;
    background-color: #f1f1f1;
}
#endScreen {
    margin: 4px auto;
    width: fit-content;
    display: none;
}

#endScreen h1 {
    font-size: 50px;
}

#endScreen p {
    font-size: 20px;
}
#endScreen #actualScore {
    color: #77ff11;
}
</style>
<script type="text/javascript" src="ext/extension.js" ></script>
<script type="text/javascript" src="gamearea.js" ></script>
<script type="text/javascript" src="components/component.js" ></script>
<script type="text/javascript" src="components/sound.js" ></script>
</head>
<body>
<script>
    const PLAYER_IMG_SOURCE = "player.png"
    const PLAYER_SPEED = 3    
    const PLAYER_WIDTH = 50
    const PLAYER_HEIGHT = 35
    const ASTERIOD_CREATE_TIME = 35
    const ASTERIOD_COUNT_PER_TIME = 3
    const ASTERIOD_SPEED = 7
    const ASTEROID_MAX_SIZE = 100
    const ASTEROID_MIN_SIZE = 50
    const GAME_WIDTH = 1280
    const GAME_HEIGHT = 720
    var userScores = []
    var myGamePiece;
    var userName = "Unknown"
    var asteroids = [];
    this.keys = [];
    var myScore;
    var mySound = null;
    var renderCallback = {
        onUpdate : function() {
            var x, y;
            for (i = 0; i < asteroids.length; i += 1) {
                if (myGamePiece.hitTest(asteroids[i])) {
                    mySound.play();
                    gameOver();
                    return;
                }
            }
            myGameArea.frameNo += 1;
            myGameArea.score += 1;
            if (myGameArea.frameNo == 1 || everyInterval(ASTERIOD_CREATE_TIME)) {
                createAsteroidsIn(x, ASTEROID_MAX_SIZE, ASTERIOD_COUNT_PER_TIME);
            }
            for (i = 0; i < asteroids.length; i += 1) {
                asteroids[i].x += -ASTERIOD_SPEED;
                asteroids[i].update(myGameArea.canvas);
            }
            movePlayerIfNeeded(myGamePiece);
            myScore.text = "SCORE: " + myGameArea.score;
            myScore.update(myGameArea.canvas);
            myGamePiece.update(myGameArea.canvas);
        },
        onKeyDown : function(event) {
            keys = (self.keys || [])
            keys[event.keyCode] = true;
        },
        onKeyUp : function(event) {
            keys[event.keyCode] = false
            accelerate(0.05);
        }
    }

    function startGame() {
        userName = document.getElementById("userName").value 
        document.getElementById("startScreen").style.display = "none"
        asteroids = [];
        this.keys = [];
        var screen = document.getElementById("endScreen")
        screen.style.display = "none";
        myGamePiece = new Player(PLAYER_WIDTH, PLAYER_HEIGHT, PLAYER_IMG_SOURCE, 10, 120);
        myScore = new CText("30px", "Consolas", "black", 40, 40, "text");
        if (mySound == null)
            mySound = new Sound("bounce.mp3");
        myGameArea = new GameArea(GAME_WIDTH, GAME_HEIGHT)
        myGameArea.setBackground("background.jpg", true)
        myGameArea.start(myGamePiece, renderCallback);
    }

    function everyInterval(n) {
        if ((myGameArea.frameNo / n) % 1 == 0) 
            return true;
        return false;
    }

    function gameOver() {
        var ctx = myGameArea.canvas.getContext("2d");
        var textSize = 60;
        var endText = "Game Over"
        ctx.font = textSize + "px Consolas";
        ctx.fillStyle = this.color;
        var centerX = (myGameArea.width - ctx.measureText(endText).width ) / 2;
        var centerY = myGameArea.height / 2;
        ctx.strokeText(endText, centerX, centerY);
        myGameArea.stop();
        
        var screen = document.getElementById("endScreen")
        screen.style.display = "block";
        document.getElementById("yourScore").innerHTML = myGameArea.score;
        userScores.push({
            score: myGameArea.score,
            userName: userName
        })
        userScores = userScores.sort((x1, x2) => x2.score - x1.score )
        var list = document.getElementById("lastScores");
        while( list.firstChild ) {
            list.removeChild( list.firstChild );
        }
        userScores.forEach(function(value, index, array) {
            var newLi = document.createElement("li");
            newLi.innerHTML = value.userName + " : " + value.score
            if (value.userName == userName && value.score == myGameArea.score) {
                newLi.id = "actualScore"
            }
            list.appendChild(newLi)
        })
        delete myGameArea;
    }

    function movePlayerIfNeeded(player) {
        // if (myGameArea.x && myGameArea.y) {
            //     myGamePiece.x = myGameArea.x;
            //     myGamePiece.y = myGameArea.y;
            // }
            player.speedX = 0;
            player.speedY = 0;
            moveByKeys(keys)
            player.newPos();
            // if (myGameArea.x && myGameArea.y) {
            //     myGamePiece.x = myGameArea.x;
            //     myGamePiece.y = myGameArea.y;
            // }
    }

    function moveByKeys() {
        var b = 0
        if (keys && keys[37]) {
            move("left"); ++b;
        }
        if (keys && keys[39]) {
            move("right"); ++b;
        }
        if (keys && keys[38]) {
            move("up"); ++b; 
        }
        if (keys && keys[40]) {
            move("down"); ++b; 
        }
        if (keys && keys[32]) {
            accelerate(-0.2)
        }
        if (b == 0) {
            clearmove();
        }
    }

    function move(dir) {
        myGamePiece.image.src = PLAYER_IMG_SOURCE;
        if (dir == "up") {myGamePiece.speedY = -PLAYER_SPEED; }
        if (dir == "down") {myGamePiece.speedY = PLAYER_SPEED; }
        if (dir == "left") {myGamePiece.speedX = -PLAYER_SPEED; }
        if (dir == "right") {myGamePiece.speedX = PLAYER_SPEED; }
    }

    function clearmove() {
        myGamePiece.image.src = PLAYER_IMG_SOURCE;
        myGamePiece.speedX = 0;
        myGamePiece.speedY = 0;
    }

    function createAsteroidsIn(xPos, maxSize, count) {
        var eY = []
        for (i = 0; i < count; ++i) {
            x = myGameArea.canvas.width;
            y = Math.floor(Math.random() * myGameArea.canvas.height)
            while (eY.containsInRange(y, maxSize)) {
                y = Math.floor(Math.random() * myGameArea.canvas.height)
            }
            eY.push(y)
            height = Math.floor(Math.random()*(maxSize - ASTEROID_MIN_SIZE + 1)) + ASTEROID_MIN_SIZE;
            asteroids.push(new Asteroid(height, height, "asteroid.png", x, y));
        }
    }

    function accelerate(gravity) {
        myGamePiece.gravity = gravity
    }

</script>
<div id="startScreen">
        <H1>Hello</H1>
        <p>Please put your name here: <input id="userName" type="text"/></p>
        <button id="startAgain" onclick="startGame()" >Start game</button>
</div>

<div id="endScreen">
    <H1>End screen</H1>
    <p>Your score: <b id="yourScore"></b></p>
    <button id="startAgain" onclick="startGame()" >Try again</button>

    <H2>Last scores:</H2>
    <ol id="lastScores"></ol>
</div>
<!-- <button onmousedown="move('up')" onmouseup="clearmove()" ontouchstart="move('up')" >UP</button>
<button onmousedown="move('down')" onmouseup="clearmove()" ontouchstart="move('down')">DOWN</button>
<button onmousedown="move('left')" onmouseup="clearmove()" ontouchstart="move('left')">LEFT</button>
<button onmousedown="move('right')" onmouseup="clearmove()" ontouchstart="move('right')">RIGHT</button> -->
</body>
</html>